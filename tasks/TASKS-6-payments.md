# üí≥ –ë–õ–û–ö 6: –ü–õ–ê–¢–ï–ñ–ò –ò –ü–û–î–ü–ò–°–ö–ò

## –û–±–æ–∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
- [ ] ‚Äî –Ω–µ —Å–¥–µ–ª–∞–Ω–æ
- [x] ‚Äî —Å–¥–µ–ª–∞–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é
- [~] ‚Äî —Å–¥–µ–ª–∞–Ω–æ —á–∞—Å—Ç–∏—á–Ω–æ (—Å–º. –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π)
- [?] ‚Äî –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å (–Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å)

---

### [?] –ó–∞–¥–∞—á–∞ 6.1 ‚Äî BottomSheet –ø–æ–¥–ø–∏—Å–∫–∏ (UI)
**–ß—Ç–æ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç:**
- –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∏–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –º–µ—Å—Ç (–∫–Ω–æ–ø–∫–∞ "üëë", –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞, –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–ª–∞—Ç–Ω–æ–π —Ñ–∏—á–µ)
- BottomSheet –Ω–∞ –ø–æ–ª–æ–≤–∏–Ω—É —ç–∫—Ä–∞–Ω–∞ —Å –∫—Ä–µ—Å—Ç–∏–∫–æ–º –∑–∞–∫—Ä—ã—Ç–∏—è
- –î–≤–∞ —Ç–∞–±–∞: "–î–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª–µ–π" | "–î–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"
- **–¢–∞–± "–î–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤"**:
  1. "+100% –∫ —à–∞–Ω—Å—É" ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ + –ø—Ä–µ–≤—å—é (–≤–∏–¥–µ–æ/–∫–∞—Ä—Ç–∏–Ω–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ)
  2. "–î–æ—Å—Ç—É–ø –∫ –∫–∞—Ç–∞–ª–æ–≥—É" ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ + –ø—Ä–µ–≤—å—é
  3. "–ë–µ–∑ –∫–∞–ø—á–∏" ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ + –ø—Ä–µ–≤—å—é
  4. "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö" ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ + –ø—Ä–µ–≤—å—é
- **–¢–∞–± "–î–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª–µ–π"**:
  1. "–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞" ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ + –ø—Ä–µ–≤—å—é
  2. "–í—ã–±–æ—Ä –º–∞—Å–∫–æ—Ç–∞" ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ + –ø—Ä–µ–≤—å—é
  3. "–í—ã–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ CSV" ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ + –ø—Ä–µ–≤—å—é
  4. "Liveness Check" ‚Äî –æ–ø–∏—Å–∞–Ω–∏–µ + –ø—Ä–µ–≤—å—é
- –ö–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–∏–Ω–∏-–∫–∞—Ä—Ç–æ—á–∫—É —Å –≤–∏–¥–µ–æ/GIF –¥–µ–º–æ + –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
- –ö–Ω–æ–ø–∫–∞ "–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É" ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –∫ –æ–ø–ª–∞—Ç–µ
- –¢—Ä–∏ —É—Ä–æ–≤–Ω—è: PLUS (190‚ÇΩ), PRO (490‚ÇΩ), BUSINESS (1490‚ÇΩ)

---

### [?] –ó–∞–¥–∞—á–∞ 6.2 ‚Äî –ö–∞—Ç–∞–ª–æ–≥ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π (–ø–ª–∞—Ç–Ω—ã–π)
**–ß—Ç–æ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç:**
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/catalog`
- –ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞:
  - –ó–∞–±–ª—é—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π (—Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–æ –Ω–µ—á–∏—Ç–∞–µ–º—ã–µ)
  - –¢–µ–∫—Å—Ç: "–ü–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ [N] —Ä–æ–∑—ã–≥—Ä—ã—à–∞–º" (N ‚Äî —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
  - "–î–æ—Å—Ç—É–ø –∫ –∫–∞—Ç–∞–ª–æ–≥—É –∑–∞ 1000‚ÇΩ/–º–µ—Å"
  - –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" ‚Üí BottomSheet —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
  - –ö–Ω–æ–ø–∫–∞ "–û–ø–ª–∞—Ç–∏—Ç—å"
- –ï—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø:
  - –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ (—Ç–æ–ª—å–∫–æ —Å promotionEnabled=true –∏ participants >= 100 –∏ –ø—Ä–æ—à–µ–¥—à–∏–µ –º–æ–¥–µ—Ä–∞—Ü–∏—é)
  - –§–∏–ª—å—Ç—Ä—ã: –ø–æ –¥–∞—Ç–µ, –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –ø–æ —Ç–∏–ø—É
  - –ö–∞—Ä—Ç–æ—á–∫–∏: –Ω–∞–∑–≤–∞–Ω–∏–µ, –¥–∞—Ç—ã, —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –∫–∞–Ω–∞–ª—ã
  - –ö–Ω–æ–ø–∫–∞ "–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å" ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—á–∞—Å—Ç–∏—è

---

### [?] –ó–∞–¥–∞—á–∞ 6.3 ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ÆKassa
**–ß—Ç–æ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç:**
- API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
  - `POST /api/payments/create` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
  - `POST /api/payments/webhook` ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±—Ö—É–∫–∞ –æ—Ç –ÆKassa
  - `GET /api/payments/status/:id` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
- –ü—Ä–æ–¥—É–∫—Ç—ã –≤ –ë–î:
  - CATALOG_MONTHLY_1000 (–∫–∞—Ç–∞–ª–æ–≥, 1000‚ÇΩ/–º–µ—Å)
  - SUBSCRIPTION_PLUS (190‚ÇΩ/–º–µ—Å)
  - SUBSCRIPTION_PRO (490‚ÇΩ/–º–µ—Å)
  - SUBSCRIPTION_BUSINESS (1490‚ÇΩ/–º–µ—Å)
- Flow –æ–ø–ª–∞—Ç—ã:
  1. –Æ–∑–µ—Ä –Ω–∞–∂–∏–º–∞–µ—Ç "–û–ø–ª–∞—Ç–∏—Ç—å" –≤ Mini App
  2. API —Å–æ–∑–¥–∞—ë—Ç –ø–ª–∞—Ç—ë–∂ –≤ –ÆKassa (redirect URL)
  3. –Æ–∑–µ—Ä –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –ÆKassa
  4. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã: –ÆKassa —à–ª—ë—Ç webhook ‚Üí API –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ‚Üí —Å–æ–∑–¥–∞—ë—Ç Purchase + Entitlement
  5. Mini App –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞!"
- –†–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (–∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏)
- –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ webhook'–æ–≤ –ÆKassa
- Return URL –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã: `https://app.randombeast.ru/payment/success?paymentId=xxx`
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/payment/success`:
  - Loading: "–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–ª–∞—Ç—É..."
  - Polling: `GET /api/payments/status/:id` –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã (–º–∞–∫—Å 30 —Å–µ–∫)
  - succeeded: –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ + "üéâ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞!" + —á—Ç–æ –ø–æ–ª—É—á–∏–ª + –∫–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
  - pending: "‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è..." + –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å polling
  - canceled: "‚ùå –û—Ç–º–µ–Ω–µ–Ω–∞" + –∫–Ω–æ–ø–∫–∞ "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞"
  - timeout: "–£–≤–µ–¥–æ–º–∏–º –≤ –±–æ—Ç–µ" + –∫–Ω–æ–ø–∫–∞ "–í–µ—Ä–Ω—É—Ç—å—Å—è"
- Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞:
  - –í–∞–ª–∏–¥–∞—Ü–∏—è IP –ÆKassa whitelist: 185.71.76.0/27, 185.71.77.0/27, 77.75.153.0/25
  - Events: payment.succeeded ‚Üí Purchase + Entitlement + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, payment.canceled ‚Üí –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å, refund.succeeded ‚Üí –æ—Ç–æ–∑–≤–∞—Ç—å Entitlement
  - Idempotency: –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ paymentId –µ—â—ë –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
- Webhook retry –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –ÆKassa –º–æ–∂–µ—Ç –ø–æ—Å–ª–∞—Ç—å –æ–¥–∏–Ω webhook –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑. –ü—Ä–æ–≤–µ—Ä—è—Ç—å Purchase.providerPaymentId (unique) ‚Äî –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ Prisma P2002 ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å. –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 200 OK (–¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏), –∏–Ω–∞—á–µ –ÆKassa –±—É–¥–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É –≤ Sentry.

---

### [?] –ó–∞–¥–∞—á–∞ 6.4 ‚Äî Telegram Stars (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –æ–ø–ª–∞—Ç–∞)
**–ß—Ç–æ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç:**
- –ß–µ—Ä–µ–∑ Bot Payments API
- –î–ª—è –º–µ–ª–∫–∏—Ö –ø–æ–∫—É–ø–æ–∫ –∏–ª–∏ –¥–ª—è —Ç–µ—Ö —É –∫–æ–≥–æ –Ω–µ—Ç –∫–∞—Ä—Ç—ã –†–§
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ü–µ–Ω –≤ Stars
- Flow:
  1. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç invoice
  2. –Æ–∑–µ—Ä –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç Stars'–∞–º–∏
  3. –ë–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç successful_payment ‚Üí —Å–æ–∑–¥–∞—ë—Ç Entitlement
- grammy –æ–±—Ä–∞–±–æ—Ç–∫–∞:
  - `bot.on("pre_checkout_query")`: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —é–∑–µ—Ä –Ω–µ –∏–º–µ–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É ‚Üí `answerPreCheckoutQuery(true)`
  - `bot.on("message:successful_payment")`: –ø–æ–ª—É—á–∏—Ç—å payload (productCode) ‚Üí —Å–æ–∑–¥–∞—Ç—å Purchase + Entitlement ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —é–∑–µ—Ä—É
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ü–µ–Ω: —Ö—Ä–∞–Ω–∏—Ç—å –≤ Product.starsPrice (int nullable)
- Invoice: `bot.api.sendInvoice(chatId, { title, description, payload: productCode, currency: "XTR", prices: [{ label, amount: starsAmount }], provider_token: "" })`

---

### [?] –ó–∞–¥–∞—á–∞ 6.5 ‚Äî –û—Ç–º–µ–Ω–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π
**–ß—Ç–æ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç:**
- –í –ø—Ä–æ—Ñ–∏–ª–µ: –±–ª–æ–∫ "–ü–æ–¥–ø–∏—Å–∫–∞" (—Ç–∏–ø + –¥–∞—Ç–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è + —Å—Ç–∞—Ç—É—Å) + –∫–Ω–æ–ø–∫–∞ "–£–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–¥–ø–∏—Å–∫–æ–π" ‚Üí BottomSheet:
  - –¢–µ–∫—É—â–∏–π –ø–ª–∞–Ω, —Å–ª–µ–¥—É—é—â–µ–µ —Å–ø–∏—Å–∞–Ω–∏–µ, –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ
  - –ö–Ω–æ–ø–∫–∞ "–ü–æ–≤—ã—Å–∏—Ç—å –ø–ª–∞–Ω" ‚Üí –≤—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞
  - –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É" (–∫—Ä–∞—Å–Ω–∞—è)
- –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ: –º–æ–¥–∞–ª–∫–∞ —Å –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ–º —á—Ç–æ –ø–æ—Ç–µ—Ä—è–µ—Ç ‚Üí POST /api/subscriptions/cancel ‚Üí –ÆKassa –æ—Ç–º–µ–Ω–∞ —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–∞ ‚Üí Entitlement.autoRenew=false ‚Üí –¥–æ—Å—Ç—É–ø –¥–æ expiresAt ‚Üí —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–æ—Ç–µ
- –ó–∞ 3 –¥–Ω—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "–ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç" + –∫–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–ª–∏—Ç—å"
- –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è: Entitlement –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è, –ª–∏–º–∏—Ç—ã ‚Üí FREE, –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–æ–∑—ã–≥—Ä—ã—à–∏ —Å PRO-—Ñ–∏—á–∞–º–∏ –¥–æ—Ä–∞–±–æ—Ç–∞—é—Ç –¥–æ –∫–æ–Ω—Ü–∞
- –ü–æ–≤—ã—à–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ (PLUS‚ÜíPRO): –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø + –¥–æ–ø–ª–∞—Ç–∞ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∏–ª–∏ –ø–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ + –±–æ–Ω—É—Å –¥–Ω–∏
- –ü–æ–Ω–∏–∂–µ–Ω–∏–µ (PRO‚ÜíPLUS): —Å–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞, —Ç–µ–∫—É—â–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- API: `POST /api/subscriptions/change` body: { newProductCode }